name: Triggered by Cloud Automator API Repository

on:
  repository_dispatch:
    types:
      - add-new-action

env:
  AWS_REGION: "us-east-1"
  BEDROCK_CLAUDE_SONNET_4_5: "us.anthropic.claude-sonnet-4-5-20250929-v1:0"
  branch_prefix: "claude-bedrock/"
  custom_instructions: |
    Please speak to humans in Japanese.
  allowed_tools: >-
    Edit
    Read
    Write
    Bash(cat:*)
    Bash(echo:*)
    Bash(find:*)
    Bash(gh pr:*)
    Bash(git add:*)
    Bash(git checkout:*)
    Bash(git commit:*)
    Bash(git push:*)
    Bash(git reset:*)
    Bash(git restore:*)
    Bash(git rm:*)
    Bash(git status:*)
    Bash(go build:*)
    Bash(go mod:*)
    Bash(go test:*)
    Bash(grep:*)
    Bash(head:*)
    Bash(ls:*)
    Bash(make build:*)
    Bash(make docs-generate:*)
    Bash(make fmt:*)
    Bash(make test:*)
    Bash(mkdir:*)
    Bash(sed -n:*)
    Bash(tail:*)
    Bash(terraform fmt:*)
    Bash(terraform init:*)
    Bash(terraform plan:*)
    Bash(terraform validate:*)
    mcp__github_file_ops__commit_files
  disallowed_tools: >-
    Bash(chmod:*)
    Bash(chown:*)
    Bash(cp:*)
    Bash(curl:*)
    Bash(docker:*)
    Bash(git push -f:*)
    Bash(git push --force:*)
    Bash(git push --force-with-lease:*)
    Bash(kubectl:*)
    Bash(mv:*)
    Bash(nc:*)
    Bash(nmap:*)
    Bash(rm:*)
    Bash(rm -rf:*)
    Bash(scp:*)
    Bash(ssh:*)
    Bash(sudo:*)
    Bash(wget:*)
    Read(.env.*)
    Read(**/*key*)
    Read(**/*password*)
    Read(**/*secret*)
    Read(**/*token*)
    Read(id_ed25519)
    Read(id_rsa)
    Write(.env*)
    Write(**/*key*)
    Write(**/*token*)
    Write(**/secrets/**)

jobs:
  update-provider:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Save diff content to file
        run: |
          # ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®å­˜åœ¨ç¢ºèªã‚’ã™ã‚‹
          if [ -z "${{ github.event.client_payload.diff_content }}" ]; then
            echo "Error: No diff_content provided in payload"
            exit 1
          fi

          # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãã§ãƒ‡ã‚³ãƒ¼ãƒ‰ã™ã‚‹
          if ! echo "${{ github.event.client_payload.diff_content }}" | base64 -d > claude_input_tmp 2>/dev/null; then
            echo "Error: Failed to decode base64 content"
            exit 1
          fi

      - name: Display diff file content
        run: |
          echo "=== PR Diff Content ==="
          cat claude_input_tmp
          echo ""
          echo "=== File Statistics ==="
          wc -l claude_input_tmp
          echo ""
          echo "=== Files Changed ==="
          grep -E '^\+\+\+|^---' claude_input_tmp || true

      - name: Upload diff as artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: api-diff
          path: claude_input_tmp
          retention-days: 30

      - name: Setup Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: latest

      - name: Configure Git
        run: |
          git config user.name "Claude Code"
          git config user.email "noreply@anthropic.com"

      - name: Implement new actions with Claude Code
        uses: anthropics/claude-code-action@90d189f3abd48655ec3e2c67c552cc23e92d6028 # v1.0.10
        with:
          use_bedrock: "true"
          use_commit_signing: "true"
          branch_prefix: ${{ env.branch_prefix }}
          github_token: ${{ github.token }}
          claude_args: >-
            --model ${{ env.BEDROCK_CLAUDE_SONNET_4_5 }}
            --system-prompt "${{ env.custom_instructions }}"
            --allowedTools "${{ env.allowed_tools }}"
            --disallowedTools "${{ env.disallowed_tools }}"
          prompt: |
            ## ã‚ãªãŸã®å½¹å‰²
            Cloud Automator ã®æ–°ã—ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ Terraform Provider ã«å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

            ## ðŸ“‹ å¿…è¦ãªæƒ…å ±ã®æŠ½å‡º
            ã¾ãšæœ€åˆã« `claude_input_tmp` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Read ãƒ„ãƒ¼ãƒ«ã§èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚

            ãã®å¾Œã€ä»¥ä¸‹ã®æƒ…å ±ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„:
            - {action_name}: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åï¼ˆä¾‹: VPC: NAT Gatewayã‚’å‰Šé™¤ï¼‰
            - {provider_type}: ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚¿ã‚¤ãƒ—ï¼ˆä¾‹: aws/gcpï¼‰
            - {action_type}: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ï¼ˆä¾‹: delete_nat_gatewayï¼‰
            - {ActionType}: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ï¼ˆä¾‹: DeleteNatGatewayï¼‰
            - {aws_service/gcp_service}: ã‚µãƒ¼ãƒ“ã‚¹åï¼ˆec2, s3, vpc ç­‰ï¼‰
            - {æ–°ã—ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®APIä»•æ§˜}: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã€åž‹ã€å¿…é ˆ/ä»»æ„ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã€èª¬æ˜Ž

            ## 1. äº‹å‰èª¿æŸ»
            ### 1.1 æ—¢å­˜ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¢ºèªã™ã‚‹
            `gh pr diff` ã‚³ãƒžãƒ³ãƒ‰ã§éŽåŽ»ã® Pull Request ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            é¡žä¼¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã¦ã€ãã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‚è€ƒã«ã—ã¾ã™ã€‚

            ```bash
            # ä¾‹: éŽåŽ»ã®å®Ÿè£…ã‚’ç¢ºèª
            gh pr diff https://github.com/CloudAutomator/terraform-provider-cloudautomator/pull/78
            ```

            ### 1.2 APIä»•æ§˜ã®ç¢ºèª
            - æŠ½å‡ºã—ãŸ API ä»•æ§˜ã‹ã‚‰ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ï¼ˆ`string`, `int`, `bool`, `array` ...ï¼‰ã‚’ç¢ºèªã™ã‚‹
            - ãƒã‚¹ãƒˆã—ãŸæ§‹é€ ï¼ˆadditional_tags ç­‰ï¼‰ã®æœ‰ç„¡ã‚’ç¢ºèªã™ã‚‹

            ## 2. å®Ÿè£…
            ### 2.1 æ–°ã—ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚­ãƒ¼ãƒžå®šç¾©ã‚’å®Ÿè£…ã™ã‚‹
            #### ã“ã®æ‰‹é †ã§ã‚ãªãŸãŒå¿…ãšå®ˆã‚‹ã“ã¨
            - æ—¢ã«å­˜åœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹å ´åˆã€Edit ãƒ„ãƒ¼ãƒ«ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨

            ```go
            ãƒ•ã‚¡ã‚¤ãƒ«: internal/schemes/job/{provider_type}/{aws_service/gcp_service}.go

            func {ActionType}ActionValueFields() map[string]*schema.Schema {
                // [1. äº‹å‰èª¿æŸ»] ã§ç¢ºèªã—ãŸæ—¢å­˜ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Œå…¨ã«è¸è¥²ã™ã‚‹å½¢ã§å®Ÿè£…ã™ã‚‹
                // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ Required: true
                // ä»»æ„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ Optional: true
            }
            ```

            ### 2.2 ãƒ—ãƒ­ãƒã‚¤ãƒ€çµ±åˆã‚’å®Ÿè£…ã™ã‚‹
            #### ã“ã®æ‰‹é †ã§ã‚ãªãŸãŒå¿…ãšå®ˆã‚‹ã“ã¨
            - æ—¢ã«å­˜åœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹å ´åˆã€Edit ãƒ„ãƒ¼ãƒ«ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨

            ```go
            ãƒ•ã‚¡ã‚¤ãƒ«: internal/provider/resource_job.go
            // [1. äº‹å‰èª¿æŸ»] ã§ç¢ºèªã—ãŸæ—¢å­˜ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Œå…¨ã«è¸è¥²ã™ã‚‹å½¢ã§å®Ÿè£…ã™ã‚‹

            ãƒ•ã‚¡ã‚¤ãƒ«: internal/provider/data_source_job.go
            // [1. äº‹å‰èª¿æŸ»] ã§ç¢ºèªã—ãŸæ—¢å­˜ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Œå…¨ã«è¸è¥²ã™ã‚‹å½¢ã§å®Ÿè£…ã™ã‚‹
            ```

            ### 2.3 å—ã‘å…¥ã‚Œãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã™ã‚‹
            #### ã“ã®æ‰‹é †ã§ã‚ãªãŸãŒå¿…ãšå®ˆã‚‹ã“ã¨
            - æ—¢ã«å­˜åœ¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹å ´åˆã€Edit ãƒ„ãƒ¼ãƒ«ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨

            ```go
            ãƒ•ã‚¡ã‚¤ãƒ«: internal/provider/resource_job_test.go
            {
                name:    "{ActionType}Action",
                jobName: fmt.Sprintf("tf-testacc-job-%s", utils.RandomString(12)),
                configFunc: func(resourceName string) string {
                    // [1. äº‹å‰èª¿æŸ»] ã§ç¢ºèªã—ãŸæ—¢å­˜ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Œå…¨ã«è¸è¥²ã™ã‚‹å½¢ã§å®Ÿè£…ã™ã‚‹
                },
                checks: []resource.TestCheckFunc{
                    // [1. äº‹å‰èª¿æŸ»] ã§ç¢ºèªã—ãŸæ—¢å­˜ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Œå…¨ã«è¸è¥²ã™ã‚‹å½¢ã§å®Ÿè£…ã™ã‚‹
                },
            },
            ```

            ### 2.4 ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œæˆ
            #### ã“ã®æ‰‹é †ã§ã‚ãªãŸãŒå¿…ãšå®ˆã‚‹ã“ã¨
            - Write ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ã¦æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã“ã¨

            ```hcl
            ãƒ•ã‚¡ã‚¤ãƒ«: examples/resources/cloudautomator_job/action/{action_type}/main.tf

            # ----------------------------------------------------------
            # - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: {ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å}
            # - ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è¨­å®š:
            #   - {è¨­å®šé …ç›®ã®èª¬æ˜Ž}
            # ----------------------------------------------------------

            resource "cloudautomator_job" "example-{action_type}" {
              // [1. äº‹å‰èª¿æŸ»] ã§ç¢ºèªã—ãŸæ—¢å­˜ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Œå…¨ã«è¸è¥²ã™ã‚‹å½¢ã§å®Ÿè£…ã™ã‚‹
            }
            ```

            ## 3. ãƒ†ã‚¹ãƒˆ
            ### 3.1 ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
            ```bash
            make test
            ```

            ## 4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
            ### 4.1 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç”Ÿæˆã™ã‚‹
            ```bash
            make docs-generate
            ```

            ## 5. ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå®Ÿè¡Œ
            ### 5.1 `make fmt` ã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹
            ```bash
            make fmt
            ```

            ## 6. æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆ
            ### 6.1 æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã™ã‚‹
            å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã—ã¦ã€æ–°ã—ã„ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆã™ã‚‹

            ```bash
            git add .
            git checkout -b ${{ env.branch_prefix }}{action_type}
            ```

            ## 7. ã‚³ãƒŸãƒƒãƒˆä½œæˆ
            ### 7.1 ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´„ã«å¾“ã£ã¦ã‚³ãƒŸãƒƒãƒˆã™ã‚‹

            ```bash
            # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¾‹:
            git commit -m "ã€ŒVPC: NAT Gatewayã‚’å‰Šé™¤ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¯¾å¿œã—ãŸ"
            ```

            ## 8. ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥
            ### 8.1 ä½œæˆã—ãŸãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹

            ```bash
            git push origin ${{ env.branch_prefix }}{action_type}
            ```

            ## å¿…ãšå®ˆã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨
            - å¿…ãš CLAUDE.md ã®è¦ç´„ã‚’éµå®ˆã™ã‚‹ã“ã¨
            - è¤‡æ•°ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆã¯ã€1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãšã¤æ®µéšŽçš„ã«å®Ÿè£…ã™ã‚‹ã“ã¨
            - ã‚³ãƒŸãƒƒãƒˆå‰ã«å¿…ãšãƒ†ã‚¹ãƒˆãŒé€šã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã“ã¨
            - ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¿…ãšæœ«å°¾ã«æ”¹è¡Œæ–‡å­—ã‚’å«ã‚ã‚‹ã“ã¨
            - æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†ã«ã¯å¿…ãšEditãƒ„ãƒ¼ãƒ«ã®ã¿ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨
            - Edit ãƒ„ãƒ¼ãƒ«ä½¿ç”¨æ™‚ã®é‡è¦ãªæ³¨æ„ç‚¹
              1. å¿…ãš Edit ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã†å‰ã«ã€Read ãƒ„ãƒ¼ãƒ«ã§è©²å½“ç®‡æ‰€ã‚’äº‹å‰ã«èª­ã¿è¾¼ã‚€ã“ã¨ï¼ˆæ­£ç¢ºãªæ–‡å­—åˆ—ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹ãŸã‚ï¼‰
              2. old_string ã¯ Read ãƒ„ãƒ¼ãƒ«ã®å‡ºåŠ›ã‹ã‚‰ç›´æŽ¥ã‚³ãƒ”ãƒ¼ã™ã‚‹ã“ã¨ï¼ˆã‚¿ãƒ–ãƒ»ã‚¹ãƒšãƒ¼ã‚¹ãƒ»æ”¹è¡Œã‚’å®Œå…¨ä¸€è‡´ã•ã›ã‚‹ï¼‰
              3. ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã¯çµ¶å¯¾ã«ã‚¿ãƒ–/ã‚¹ãƒšãƒ¼ã‚¹ã‚’å¤‰æ›´ã—ãªã„ã“ã¨ï¼ˆå…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨å®Œå…¨ä¸€è‡´ãŒå¿…é ˆï¼‰
              4. ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—æ–‡å­—ï¼ˆ\", \\ç­‰ï¼‰ã«æ³¨æ„ã™ã‚‹ã“ã¨
              5. å¤±æ•—ã—ãŸå ´åˆã¯ã€ã‚ˆã‚Šåºƒã„ç¯„å›²ï¼ˆå‰å¾Œã®è¡Œã‚’å«ã‚€ï¼‰ã§å†è©¦è¡Œã™ã‚‹ã“ã¨

            ## é–‹å§‹æ‰‹é †
            1. æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—: Read ãƒ„ãƒ¼ãƒ«ã§ `claude_input_tmp` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
            2. å·®åˆ†å†…å®¹ã‚’è§£æžã—ã¦æ–°ã—ã„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç‰¹å®šã™ã‚‹
            3. ä¸Šè¨˜ã®æ‰‹é †ã«å¾“ã£ã¦å®Ÿè£…ã‚’é€²ã‚ã‚‹

            ãã‚Œã§ã¯ä½œæ¥­ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚

      - name: Create Pull Request
        id: create_pr
        run: |
          # ä½œæˆã•ã‚ŒãŸãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—ã™ã‚‹
          BRANCH_NAME=$(git branch --show-current)

          # ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰ claude-bedrock/ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ã—ã¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åã‚’å–å¾—ã™ã‚‹
          ACTION_NAME="${BRANCH_NAME#${{ env.branch_prefix }}}"

          # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹
          COMMIT_MESSAGE=$(git log -1 --pretty=%B)

          # examples ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’å–å¾—ã™ã‚‹
          EXAMPLE_FILE="examples/resources/cloudautomator_job/action/${ACTION_NAME}/main.tf"

          if [ -f "$EXAMPLE_FILE" ]; then
            EXAMPLE_CONTENT=$(cat "$EXAMPLE_FILE")
          else
            EXAMPLE_CONTENT="# examples ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ: $EXAMPLE_FILE"
          fi

          # PRã®èª¬æ˜Žæ–‡ã‚’ç”Ÿæˆã™ã‚‹
          cat > pr_body.md << EOF
          ${COMMIT_MESSAGE}

          # resource example
          \`\`\`
          ${EXAMPLE_CONTENT}
          \`\`\`
          EOF

          # PRã‚’ä½œæˆã™ã‚‹
          gh pr create \
            --title "${COMMIT_MESSAGE}" \
            --body-file pr_body.md \
            --base main \
            --head "${BRANCH_NAME}"
        env:
          GH_TOKEN: ${{ github.token }}
